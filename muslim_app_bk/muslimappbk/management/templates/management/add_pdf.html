{% extends "management/index.html" %}
{% load static %}
{% load widget_tweaks %}
{% load i18n %}
{% load custom_tags %}

{% block title %}
{% if not slug %}
    {% trans 'Add PDF' %}
{% else %}
    {% trans 'Edit PDF' %}
{% endif %}
{% endblock %}
{% block stylesheet %}
  {{ block.super }}
  <link href="{% static 'taggit_labels/css/taggit_labels.css' %}" rel="stylesheet">
  <style>
    #submit_btn {
      position: relative;
      left: 50%;
      transform: translateX(-50%); /* this will calculate what 50% of the element width is and will move it across the X-axis. The negative value ensures it moves to the left. */
    }
  </style>
{% endblock %}
{% block mainContent %}
          {% if not slug %}
            <form id="pdf_form" method="POST" action="{% url 'management:add_pdf' %}" enctype="multipart/form-data">
          {% else %}
            <form id="pdf_form" method="POST" action="{% url 'management:edit_pdf' slug %}" enctype="multipart/form-data">
          {% endif %}
            {% csrf_token %}
            <div class="row">
              <div class="col-md-6">
                <div class="">
                  <h6 class="">{% trans 'PDF' %}</h6>
                  {% if pdf_form.non_field_errors %}
                    <div class="alert alert-danger" role="alert">
                      {% for error in pdf_form.non_field_errors %}
                        {{ error }}
                      {% endfor %}
                    </div>
                  {% endif %}

                  {% for hidden_field in pdf_form.hidden_fields %}
                   {% if hidden_field.errors %}
                     <div class="alert alert-danger" role="alert">
                       {% for error in hidden_field.errors %}
                         {{ hidden_field.name }}: {{ error }}
                       {% endfor %}
                     </div>
                   {% endif %}
                  {% endfor %}
                  <div class="">
                      <div class="form-group">
                        <label>{{ pdf_form.title.label }}</label>
                        {% render_field pdf_form.title class="form-control" %}
                        {% if pdf_form.title.errors %}
                          <div class="invalid-feedback d-block">
                              {{ pdf_form.title.errors }}
                          </div>
                        {% endif %}
                      </div>
                      <div class="form-group">
                        <label>{{ pdf_form.description.label }}</label>
                        {% render_field pdf_form.description class="form-control" %}
                        {% if pdf_form.description.errors %}
                          <div class="invalid-feedback d-block">
                              {{ pdf_form.description.errors }}
                          </div>
                        {% endif %}
                      </div>
                      <div class="form-group">
                        {% trans 'tag' %}
                        {{ pdf_form.tags }}
                        {% if pdf_form.tags.errors %}
                          <div class="invalid-feedback d-block">
                            {{ pdf_form.tags.errors }}
                          </div>
                        {% endif %}
                      </div>
                      <div class="form-group row pl-3">
                        <button type="button" class="button btn-primary btn col-auto" id="pdf_input_btn">{% trans 'Upload PDF' %}</button>
                        <input type="file" id="pdf_input" accept=".pdf" style="display:none" multiple>
                        <div class="col d-none" id="pdf-progress-div">
                          <div class="progress" style="height:90%; width:100%">
                           <div id="pdf_upload_progress" class="progress-bar bg-success" role="progressbar" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100">0%</div>
                          </div>
                        </div>
                      </div>
                      <div class="form-group">
                        <label>{{ pdf_form.author.label }}</label>
                        {% render_field pdf_form.author class="form-control" %}
                      </div>
                      <div class="form-group">
                        <label>{{ pdf_form.publish_year.label }}</label>
                        {% render_field pdf_form.publish_year class="form-control" %}
                        {% if pdf_form.publish_year.errors %}
                          <div class="invalid-feedback d-block">
                              {{ pdf_form.publish_year.errors }}
                          </div>
                        {% endif %}
                      </div>
                      <button class="button btn-primary btn" style="margin-bottom: 5px">{% trans 'Submit' %}</button>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                  {% if slug %}
                  <embed src="{{ pdf_form.instance.latest_pdf.file.url }}" type="application/pdf" width="100%" height="900px" />
                  {% endif %}
                  {{ pdf_form.pdf_files }}
                  {{ pdf_form.upload_by.as_hidden }}
              </div>
            </div>
          </form>
{% endblock %}
{% block javascript %}
  {{ block.super }}
  <script src="{% static 'taggit_labels/js/taggit_labels.js' %}" type="text/javascript"></script>
  <script>
//  var imgSrc = $('#image_input').siblings('a').prop('href');
  var videoUploading = false;    
  $(function(){
      
//    if ( imgSrc!== undefined){
//        $('#image_img').prop('src', imgSrc);
//    }
      
     $('#pdf_input_btn').click(function(){
    	$('#pdf_input').click();
    });
    
    $('#pdf_input').change(function(){
        var files = this.files;
        
        // var fileList
        if(files.length !== 0){
          $('#pdf-progress-div').removeClass('d-none');
            
          var formData = new FormData();
          $.each(files, function(i, file){
              formData.append('pdf', file)
          });
          
          $.ajax({
              url: "{% url 'management:upload_pdf' %}",
              type: 'POST',
              data: formData,
              cache: false,
              dataType: 'json',
              processData: false, // Don't process the files
              contentType: false, // Set content type to false as jQuery will tell the server its a query string request
              xhr: function()
              {
                var xhr = new window.XMLHttpRequest();
                //Upload progress
                xhr.upload.addEventListener("progress", function(evt){
                  if (evt.lengthComputable) {
                    var percentComplete = (evt.loaded / evt.total*100).toFixed(0) + '%';
                    //Do something with upload progress
                    console.log(percentComplete);
                    $('#pdf_upload_progress').css('width', percentComplete);
                    $('#pdf_upload_progress').text(percentComplete);
                  }
                }, false);
                //Download progress
                xhr.addEventListener("progress", function(evt){
                  if (evt.lengthComputable) {
                    var percentComplete = evt.loaded / evt.total;
                    //Do something with download progress
                    console.log(percentComplete);
                  }
                }, false);
                return xhr;
              },
          }).done(function(data){
            console.log(data);
            var pdf_ids = data.pdf_ids;
            $('#pdf_files').val(pdf_ids.join());
          });
        }
      });
      
      $('#pdf_form').submit(function(){
            $('#pdf_input').prop('disabled', true);
        });
      
      
    setActiveMenu(2);
  });
  </script>
{% endblock %}
