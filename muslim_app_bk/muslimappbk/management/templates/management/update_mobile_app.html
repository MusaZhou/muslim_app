{% extends "management/index.html" %}
{% load static %}
{% load widget_tweaks %}
{% block title %}Update Application{% endblock %}
{% block stylesheet %}
  {{ block.super }}
  <style>
    .imgDivTop {
      padding:5px;
      margin-right:5px;
    }

    .gap-20 .imgDivTop .delImgBtn {
      vertical-align: top;
    }

    #submit_btn {
      position: relative;
      left: 50%;
      transform: translateX(-50%); /* this will calculate what 50% of the element width is and will move it across the X-axis. The negative value ensures it moves to the left. */
    }
  </style>
{% endblock %}
{% block mainContent %}
          <form id="update_app_form" method="POST" action="{% url 'management:update_mobile_app' updateAppModelForm.slug.value %}" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="row gap-20 pos-r">
              <div class="col-md-6">
                <div class="bgc-white p-20 bd">
                  <h6 class="c-grey-900">{{ updateAppModelForm.name.value|add:' Version '|add:updateAppVersionModelForm.version_number.value}} </h6>
                  <div class="mT-30">
                      <div class="form-group">
                        <label>{{ updateAppModelForm.description.label }}</label>
                        {% render_field updateAppModelForm.description class="form-control" %}
                      </div>
                      <div class="form-group">
                        <label>{{ updateAppModelForm.category.label }}</label>
                        {% render_field updateAppModelForm.category class="form-control" %}
                      </div>
                      <div class="form-group">
                        <label for="appTags">{{ updateAppModelForm.tags.label }}</label>
                        {% render_field updateAppModelForm.tags class="form-control" %}
                      </div>
                      <button id="imgCtrBtn" type="button" class="button btn-primary btn cur-p" style="margin-bottom: 5px">Select Images +</button>
                      <input type="file" style="display:none" id="imgCtr" accept="image/*" multiple>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="bgc-white p-20 bd">
                  <div class="mT-30">
                      {% if updateAppModelForm.non_field_errors %}
                        <div class="alert alert-danger" role="alert">
                          {% for error in updateAppModelForm.non_field_errors %}
                            {{ error }}
                          {% endfor %}
                        </div>
                      {% endif %}
                      {% for hidden_field in updateAppModelForm.hidden_fields %}
                       {% if hidden_field.errors %}
                         <div class="alert alert-danger" role="alert">
                           {% for error in hidden_field.errors %}
                             {{ hidden_field.name }}: {{ error }}
                           {% endfor %}
                         </div>
                       {% endif %}
                      {% endfor %}
                      {% render_field updateAppModelForm.name type="hidden" %}
                      {% render_field updateAppModelForm.slug type="hidden" %}

                      <div class="form-group">
                        <label>{{ updateAppModelForm.video_url.label}}</label>
                        {% render_field updateAppModelForm.video_url class="form-control" placeholder="http://www.example.com"%}
                      </div>
                      <button type="button" class="button btn-primary btn cur-p" style="margin-bottom: 5px">Play</button>
                      <video width="100%" height="300" controls></video>
                      <button id="submit_btn" class="btn cur-p button btn-success center" style="margin-left:auto;margin-right:auto;margin-top:50px;" >Add New Application</button>
                  </div>
                </div>
              </div>
                <div class="divSplitter" style="display:none"></div>
                {% for imgUrl in imgUrls %}
                  <div class="bgc-white bd imgDivTop">
                      <img src="{{ imgUrl }}" width="auto" height="200px" class="appImg rounded">
                      <button type="button" class="btn cur-p btn-secondary delImgBtn">x</button>
                      <input type="checkbox" class="delImgCheckbox" style="display:none">
                      <input type="number" class="orderImg" style="display:none">
                  </div>
                {% endfor %}
            </div>
            {{ updateAppModelForm.imgIds }}

          </form>
{% endblock %}
{% block javascript %}
  {{ block.super }}
  <script>
  var imageDivTemplate = '<div class="bgc-white bd imgDivTop">'+
                        '<img width="auto" height="200px" class="appImg rounded">'+
                        '<button type="button" class="btn cur-p btn-secondary delImgBtn">x</button>'+
                        '<input type="checkbox" class="delImgCheckbox" style="display:none">'+
                        '<input type="number" class="orderImg" style="display:none">'+
                        '</div>';

  {% if updateAppModelForm.imgIds.value is not None %}
  var imgIds = [{{ updateAppModelForm.imgIds.value }}];
  {% else %}
  var imgIds = [];
  {% endif %}

  $(function(){

    $('#imgCtrBtn').click(function(){
      $('#imgCtr').click();
    });

    $('#imgCtr').change(function(){
      var files = this.files;
      // var fileList
      if(files !== null){
        var formData = new FormData();
        $.each(files, function(i, file){
          formData.append('images', file)
        });

        $.ajax({
            url: "{% url 'management:add_app_images' %}",
            type: 'POST',
            data: formData,
            cache: false,
            dataType: 'json',
            processData: false, // Don't process the files
            contentType: false, // Set content type to false as jQuery will tell the server its a query string request
        }).done(function(data){
          console.log(data);
          imgIds = imgIds.concat(data);
          $.each(files, function(i, file){
            var imgEle = newImageDiv();
            displayImage(file, imgEle);
          });
          attachEvents();
        });
      }
    });

    $('#update_app_form').submit(function(){
      $('#imgIds').val(imgIds);
      $(this).submit();
    });

    attachEvents()
  });

  function newImageDiv(){
    var currentImgCount = $('.imgDivTop').length;
    var newImgDiv = $(imageDivTemplate.repeat(1));
    currentImgCount > 0 ? $('.imgDivTop').last().after(newImgDiv) : $('.divSplitter').after(newImgDiv);
    return newImgDiv.find('.appImg');
  }

  function displayImage(file, imgEle){
    var reader = new FileReader();
    reader.onload = function(e) {
      // Set the img src property using the data URL.
      imgEle.prop('src', reader.result);
    }

    reader.readAsDataURL(file);
  }

  function attachEvents(){
    $('.delImgBtn').click(function(){
      var index = $(this).parents('.imgDivTop').index('.imgDivTop');
      imgIds.splice(index, 1);
      $(this).siblings('.delImgCheckbox').prop('checked', true);
      $(this).parents('.imgDivTop').remove();
    });
  }
  </script>
{% endblock %}
